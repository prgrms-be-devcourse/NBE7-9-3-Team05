name: Backend CD

on:
  push:
    branches: [ main ]
    paths:
      - "motionit/**"
      - ".github/workflows/backend-cd.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-backend
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: motionit

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        working-directory: motionit
        run: |
          IMAGE_NAME="minibrb/motionit-backend"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

          echo "Building Docker image..."
          docker build -t ${IMAGE_NAME}:latest \
                       -t ${IMAGE_NAME}:${TIMESTAMP}-${SHORT_SHA} \
                       .

          echo "Pushing Docker images..."
          docker push ${IMAGE_NAME}:latest
          docker push ${IMAGE_NAME}:${TIMESTAMP}-${SHORT_SHA}

          echo "‚úì Docker images pushed successfully"
          echo "  - ${IMAGE_NAME}:latest"
          echo "  - ${IMAGE_NAME}:${TIMESTAMP}-${SHORT_SHA}"

      - name: Copy deploy script to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "motionit/scripts/deploy-blue-green.sh"
          target: "/home/ubuntu"
          strip_components: 2

      - name: Deploy to EC2 (Blue-Green)
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_CLOUDFRONT_DOMAIN: ${{ secrets.AWS_CLOUDFRONT_DOMAIN }}
          AWS_CLOUDFRONT_KEY_ID: ${{ secrets.AWS_CLOUDFRONT_KEY_ID }}
          AWS_CLOUDFRONT_PRIVATE_KEY_PATH: ${{ secrets.AWS_CLOUDFRONT_PRIVATE_KEY_PATH }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION: "3600"
          JWT_REFRESH_TOKEN_EXPIRATION: "1209600"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DATABASE_URL,DB_USERNAME,DB_PASSWORD,AWS_ACCESS_KEY,AWS_SECRET_KEY,AWS_S3_BUCKET_NAME,AWS_CLOUDFRONT_DOMAIN,AWS_CLOUDFRONT_KEY_ID,AWS_CLOUDFRONT_PRIVATE_KEY_PATH,JWT_SECRET,JWT_ACCESS_TOKEN_EXPIRATION,JWT_REFRESH_TOKEN_EXPIRATION,OPENAI_API_KEY,YOUTUBE_API_KEY,KAKAO_CLIENT_ID
          script: |
            cd /home/ubuntu
            chmod +x deploy-blue-green.sh
            
            export DATABASE_URL="${DATABASE_URL}"
            export DB_USERNAME="${DB_USERNAME}"
            export DB_PASSWORD="${DB_PASSWORD}"
            export AWS_ACCESS_KEY="${AWS_ACCESS_KEY}"
            export AWS_SECRET_KEY="${AWS_SECRET_KEY}"
            export AWS_S3_BUCKET_NAME="${AWS_S3_BUCKET_NAME}"
            export AWS_CLOUDFRONT_DOMAIN="${AWS_CLOUDFRONT_DOMAIN}"
            export AWS_CLOUDFRONT_KEY_ID="${AWS_CLOUDFRONT_KEY_ID}"
            export AWS_CLOUDFRONT_PRIVATE_KEY_PATH="${AWS_CLOUDFRONT_PRIVATE_KEY_PATH}"
            export JWT_SECRET="${JWT_SECRET}"
            export JWT_ACCESS_TOKEN_EXPIRATION="${JWT_ACCESS_TOKEN_EXPIRATION}"
            export JWT_REFRESH_TOKEN_EXPIRATION="${JWT_REFRESH_TOKEN_EXPIRATION}"
            export OPENAI_API_KEY="${OPENAI_API_KEY}"
            export YOUTUBE_API_KEY="${YOUTUBE_API_KEY}"
            export KAKAO_CLIENT_ID="${KAKAO_CLIENT_ID}"
            
            ./deploy-blue-green.sh

      - name: Deployment Success
        if: success()
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "================================="
          echo "üöÄ Deployment Completed!"
          echo "================================="
          echo "Server: http://52.78.181.248"
          echo "Health: http://52.78.181.248/actuator/health"
          echo "Image: minibrb/motionit-backend:${TIMESTAMP}-${SHORT_SHA}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "================================="

      - name: Deployment Failed
        if: failure()
        run: |
          echo "================================="
          echo "‚ùå Deployment Failed"
          echo "================================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "To rollback, SSH to EC2 and run:"
          echo "  cd /home/ubuntu"
          echo "  ./rollback.sh <previous-tag>"
          echo "================================="
          exit 1
