name: Backend CD

on:
  push:
    branches: [ main ]
    paths:
      - "motionit/**"
      - ".github/workflows/backend-cd.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "motionit/**"
      - ".github/workflows/backend-cd.yml"
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

permissions:
  contents: read
  pull-requests: write  # PR ì½”ë©˜íŠ¸ë¥¼ ìœ„í•´ ì¶”ê°€

jobs:
  deploy:
    runs-on: self-hosted  # â† Self-hosted runner ì‚¬ìš©

    defaults:
      run:
        working-directory: motionit

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        working-directory: motionit
        run: |
          IMAGE_NAME="minibrb/motionit-backend"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

          echo "Building Docker image..."
          docker build -t ${IMAGE_NAME}:latest \
                       -t ${IMAGE_NAME}:${TIMESTAMP}-${SHORT_SHA} \
                       .

          echo "Pushing Docker images..."
          docker push ${IMAGE_NAME}:latest
          docker push ${IMAGE_NAME}:${TIMESTAMP}-${SHORT_SHA}

          echo "âœ“ Docker images pushed successfully"
          echo "  - ${IMAGE_NAME}:latest"
          echo "  - ${IMAGE_NAME}:${TIMESTAMP}-${SHORT_SHA}"

      - name: Deploy Application (Blue-Green)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: motionit
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_CLOUDFRONT_DOMAIN: ${{ secrets.AWS_CLOUDFRONT_DOMAIN }}
          AWS_CLOUDFRONT_KEY_ID: ${{ secrets.AWS_CLOUDFRONT_KEY_ID }}
          AWS_CLOUDFRONT_PRIVATE_KEY_PATH: ${{ secrets.AWS_CLOUDFRONT_PRIVATE_KEY_PATH }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION: "3600"
          JWT_REFRESH_TOKEN_EXPIRATION: "1209600"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
        run: |
          chmod +x scripts/deploy-blue-green.sh
          ./scripts/deploy-blue-green.sh

      - name: Test Build (PR Only)
        if: github.event_name == 'pull_request'
        working-directory: motionit
        run: |
          echo "ğŸ” PR ë°°í¬ í…ŒìŠ¤íŠ¸ - Docker ì´ë¯¸ì§€ ë¹Œë“œ í™•ì¸"
          echo "âœ… Docker ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë¹Œë“œë˜ê³  Pushë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "âœ… Self-hosted runner í™˜ê²½ì—ì„œ ì‹¤í–‰ í™•ì¸"
          echo ""
          echo "ğŸ“‹ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
          echo "  - Docker build: âœ…"
          echo "  - Docker push: âœ…"
          echo "  - Runner í™˜ê²½: âœ…"
          echo ""
          echo "âš ï¸  ì‹¤ì œ ë°°í¬ëŠ” main ë¸Œëœì¹˜ merge í›„ ì‹¤í–‰ë©ë‹ˆë‹¤."

      - name: Comment PR (Test Result)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ

            ### âœ… ë°°í¬ ì „ ì²´í¬ ì™„ë£Œ
            - Docker ì´ë¯¸ì§€ ë¹Œë“œ: **ì„±ê³µ**
            - Docker Hub Push: **ì„±ê³µ**
            - Self-hosted runner: **ì •ìƒ**

            ### ğŸ“¦ ë°°í¬ ëŒ€ìƒ
            - Image: \`minibrb/motionit-backend:latest\`
            - Runner: \`self-hosted\`
            - ë°°í¬ ë°©ì‹: \`Blue-Green\`

            ### â­ï¸ ë‹¤ìŒ ë‹¨ê³„
            ì´ PRì„ \`main\` ë¸Œëœì¹˜ì— mergeí•˜ë©´ ìë™ìœ¼ë¡œ í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤.

            âš ï¸ **ì£¼ì˜**: Main merge ì‹œ ì‹¤ì œ ì„œë²„ì— ë°°í¬ë©ë‹ˆë‹¤!
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });

      - name: Deployment Success
        if: success()
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "Server: http://52.78.181.248:8080"
          echo "Health: http://52.78.181.248:8080/actuator/health"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed. Check the logs above for details."
          exit 1
